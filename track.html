<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Track Shipment | Pulse Courier</title>
  <link rel="icon" href="assets/img/favicons/favicon.ico" />
  <link href="assets/css/theme.css" rel="stylesheet" />
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top py-3 d-block" data-navbar-on-scroll="data-navbar-on-scroll">
  <div class="container">
    <a class="navbar-brand" href="index.html"><img src="assets/img/gallery/logo.png" height="45" alt="logo" /></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse border-top border-lg-0 mt-4 mt-lg-0" id="navbarNav">
      <ul class="navbar-nav ms-auto pt-2 pt-lg-0 font-base">
        <li class="nav-item px-2"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item px-2"><a class="nav-link" href="#services">Our Services</a></li>
        <li class="nav-item px-2"><a class="nav-link" href="#findUs">Find Us</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Tracking Section -->
<section class="py-7" style="margin-top: 100px;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow-sm p-4">
          <h4 class="text-center mb-4">Track Your Package</h4>
          <form id="tracking-form">
            <div class="mb-3">
              <label for="trackingNumber" class="form-label">Enter Tracking Number</label>
              <input type="text" class="form-control" id="trackingNumber" placeholder="e.g. 737374747474" required />
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">Track</button>
            </div>
          </form>
          <div id="tracking-result" class="mt-4" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Firestore Logic -->
<script type="module">
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
  import { app } from './admin-panel/firebase-config.js';

  const db = getFirestore(app);

  const form = document.getElementById("tracking-form");
  const resultBox = document.getElementById("tracking-result");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const trackingNumber = document.getElementById("trackingNumber").value.trim();
    resultBox.style.display = "block";
    resultBox.innerHTML = "<p class='text-center text-muted'>Searching...</p>";

    try {
      const docRef = doc(db, "shipments", trackingNumber);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        resultBox.innerHTML = "<p class='text-danger text-center'>Tracking number not found.</p>";
        return;
      }

      const data = docSnap.data();
      const company = data.companyInfo || {};
      const sender = data.senderInfo || {};
      const receiver = data.receiverInfo || {};
      const details = data.shipmentDetails || {};
      const history = data.shipmentHistory || "No updates yet.";
      const attachments = data.attachments || {};

      resultBox.innerHTML = `
        <h5 class="text-success">Tracking: ${trackingNumber}</h5>
        <hr/>
        <p><strong>Status:</strong> ${details.status || "In Transit"}</p>
        <p><strong>Delivery Priority:</strong> ${details.deliveryPriority || "Standard"}</p>
        <p><strong>Expected Delivery:</strong> ${details.expectedDate || "N/A"}</p>
        <p><strong>Actual Delivery:</strong> ${details.actualDate || "Pending"}</p>
        <p><strong>Assigned Agent:</strong> ${company.assignedAgent || "N/A"}</p>
        <hr/>
        <h6>Sender:</h6>
        <p>${sender.fullName || "N/A"} (${sender.phone || "-"})<br>${sender.address || "-"}</p>
        <h6>Receiver:</h6>
        <p>${receiver.fullName || "N/A"} (${receiver.phone || "-"})<br>${receiver.address || "-"}</p>
        <hr/>
        <h6>Shipment Details:</h6>
        <p><strong>Type:</strong> ${details.type || "N/A"} | <strong>Weight:</strong> ${details.weight || "-"}</p>
        <p><strong>Items:</strong> ${details.itemsCount || "0"} | <strong>Value:</strong> $${details.value || "0.00"}</p>
        <p><strong>Payment:</strong> ${details.paymentStatus || "N/A"}</p>
        <hr/>
        <h6>History:</h6>
        <p>${history}</p>
        ${attachments.photo ? `
          <hr/>
          <h6>Package Photo:</h6>
          <img src="${attachments.photo}" alt="Package Photo" style="max-width: 100%; border-radius: 8px;">
        ` : ""}
      `;
    } catch (error) {
      console.error("Error fetching tracking info:", error);
      resultBox.innerHTML = `<p class="text-danger text-center">An error occurred while fetching tracking info. Please try again later.</p>`;
    }
  });
</script>

<!-- Bootstrap -->
<script src="assets/js/bootstrap.bundle.min.js"></script>
</body>
</html>
